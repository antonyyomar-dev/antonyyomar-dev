-- Query 1: Mostrar el total de ingresos generados por cada categoría de producto, considerando solo las ofertas aceptadas.

SELECT P.categoria, SUM(O.monto_ofertado) AS total_ingresos
FROM Producto AS P
    INNER JOIN Oferta AS O ON P.id_subasta = O.id_subasta
WHERE O.estado = 'Aceptada'
GROUP BY P.categoria
ORDER BY total_ingresos DESC
GO



-- Query 2:Mostrar cuál es el método de pago más utilizado por los compradores dentro de la plataforma, indicando el tipo de método y el proveedor correspondiente.

CREATE VIEW VMetodoPagoMasUsado AS
    SELECT MP.tipo,nombre_proveedor, COUNT(id_metodo_pago) AS Frecuencia_uso
    FROM Pago AS P 
        INNER JOIN Metodo_pago AS MP ON P.id_metodo_pago = MP.id
   GROUP BY MP.tipo, nombre_proveedor
GO

SELECT DISTINCT tipo,nombre_proveedor, Frecuencia_uso 
FROM VMetodoPagoMasUsado
WHERE Frecuencia_uso = (SELECT MAX(Frecuencia_uso) FROM VMetodoPagoMasUsado)
GO 



-- Query 3: Hallar la cantidad total de ventas y el monto obtenido en las subastas para cada año registrado.


SELECT 
    YEAR(fecha_compra) as Year, 
    COUNT(C.id) as Total_ventas,
    SUM(monto_ofertado) as Total_monto
FROM Compra as C 
    INNER JOIN Oferta AS O ON C.id_oferta = O.id
WHERE C.estado_compra = 'Completada'
GROUP BY YEAR(fecha_compra)
ORDER BY Year




-- Query 4:Enunciado: Mostrar el total de compras y el monto total pagado por cada método de pago correspondiente.

SELECT 
    MP.tipo AS Tipo_Metodo,
    MP.nombre_proveedor AS Proveedor,
    COUNT(P.id) AS Total_Pagos,
    SUM(P.monto_final) AS Total_Pagado
FROM Pago AS P
    INNER JOIN Metodo_pago AS MP ON P.id_metodo_pago = MP.id
GROUP BY MP.tipo, MP.nombre_proveedor
ORDER BY Total_Pagado DESC
GO



-- Query 5:Crea una función que devuelva el monto total recaudado y el número de compras completadas en un año específico. Debe incluir el año como parámetro de entrada.

CREATE FUNCTION FNumeroVentasPorAnio (@Anio datetime)
RETURNS TABLE
AS
RETURN
(   SELECT 
        YEAR(C.fecha_compra) AS Año,
        COUNT(C.id) AS Total_Compras,
        SUM(O.monto_ofertado) AS Total_Recaudado
    FROM Compra AS C
    INNER JOIN Oferta AS O ON C.id_oferta = O.id
    WHERE C.estado_compra = 'Completada'
      AND YEAR(C.fecha_compra) = @Anio
    GROUP BY YEAR(C.fecha_compra)   )
GO
SELECT * FROM DBO.FNumeroVentasPorAnio(2024)
GO



-- Query6: Calcular el promedio del monto ofertado en las subastas de cada categoría de producto. Mostrar el nombre de la categoría y el promedio de las ofertas realizadas

SELECT 
    P.categoria AS Categoria,
    AVG(O.monto_ofertado) AS Promedio_Ofertas
FROM Producto AS P
INNER JOIN Subasta AS S ON P.id_subasta = S.id
INNER JOIN Oferta AS O ON S.id = O.id_subasta
GROUP BY P.categoria
ORDER BY Promedio_Ofertas desc
go



